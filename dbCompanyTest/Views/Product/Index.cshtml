
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Back_Layout.cshtml";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">


<div class="container-fluid px-4">  
    </div>
    <div class="card mb-4">
        <div class="card-header">           
            商品一覽
        </div>
        <div class="card-body">
            <table id="tableAll">
                <thead>
                    <tr>
                        <th>圖示</th>
                        <th>編號</th>
                        <th>上架</th>
                        <th>名稱</th>
                        <th>價格</th>
                        <th>品介紹</th>
                        <th>材質</th>
                        <th>重量</th>
                        <th>成本</th>
                        <th>分類</th>
                        <th>鞋種</th>
                        <th>新增</th>        
                        <th>修改</th>
                        <th>刪除</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts{
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.13.1/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.13.1/datatables.min.js"></script>

        <script>

        let url01 = '@Url.ActionLink("showlist","Product")';
        let url02 = '@Url.RouteUrl("default", new{Controller = "TestClients", Action = "showlist"})';
        //用 table代表整個表單
        let table = null;
        console.log("url01=" + url01);
        let funcLoad = () => {
            table = $('#tableAll').DataTable(
                {
                    /*@Url.Action()只能在cshtml上執行，因為是Rezer語法，在js檔內只會被當成字串 */
                    "ajax": url01,
                    /* "ajax": '@Url.Action("showlist", "Product")',*/
                    //ajax: "http://localhost:5277/HCustomer/showlist",
                    "lengthMenu": [[5, 10, 25, 50, -1], [5,10, 25, 50, "All"]],
                    "columns":
                    [
                            {  //master detail button
                                className: 'details-control',
                                orderable: false,
                                data: null,
                                defaultContent: '',
                                //用渲染 新增子項目按鍵
                                render: function (data, type, row) {
                                                                    return '<i class="bi bi-plus-circle-fill"></i>';
                                },
                                width: '6%'
                            },
                            { "data": "商品編號id","width": "6%" },
                            { "data": "上架時間" },
                            { "data": "商品名稱" },
                            { "data": "商品價格","width": "6%"  },
                            { "data": "商品介紹","width": "15%" },
                            { "data": "商品材質","width": "6%"  },
                            { "data": "商品重量","width": "6%"  },
                            { "data": "商品成本","width": "6%"  }, 
                            { "data": "商品分類","width": "6%"  },
                            { "data": "商品鞋種","width": "6%"  },   
                            {
                                data: null,
                                className: 'create',
                                render: function (data, type, row) {
                                    return '<button type="submit" class="btn btn-primary" id="btnEdit" title="新增"><i class="fas fa-edit"></i>新增</button>';

                                },
                                orderable: false,
                                width: '7%'
                            },
                            {
                                data: null,
                                className: 'edit',
                                render: function (data, type, row) {
                                    return '<button type="submit" class="btn btn-primary" id="btnEdit" title="修改"><i class="fas fa-edit"></i> 修改</button>';

                                },
                                orderable: false,
                                width: '7%'
                            },
                            {
                                data: null,
                                className: 'del',
                                render: function (data, type, row) {
                                    return '<button type="submit" class="btn btn-primary" id="dataDel" title="刪除"><i class="fa fa-minus-square"></i> 刪除</button>';
                                },
                                orderable: false,
                                width: '7%'
                            }
                    ]

                });
        }

        //每一行明細的點擊事件
        $('#tableAll>tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);

            if (row.child.isShown()) {
                //如果該行已打開, 則關閉
                row.child.hide(); //隱藏row.child的節點
                tr.removeClass('shown'); //移除tr的類別
                                tr.children('td.details-control').html('<i class="bi bi-plus-circle-fill"></i>');//顯示子table
            }
            else {
                //如果這行是關閉狀態
                var rowchild = row.child(details(row.data()));; //觸發detail事件
                rowchild.show(); //觸發format事件，並將字串以HTML秀出
                tr.addClass('shown');
                            tr.children('td.details-control').html('<i class="bi bi-x-circle-fill"></i>');
            }
        });

        //子表單 details
        function details(d) {
            //使用資料庫存取
            var CdData = d;
            //使用連結
            var CDataID = d.商品編號id;
            //console.log("CDID=" +CDataID);
            //let jsondata = JSON.stringify({ id : CDataID });      
            let dUrl = '@Url.ActionLink("showDetail","Product")';
            let appH = "";
            let gg="";
            console.log(dUrl);
            console.log(CDataID)
            //用ajax抓Detail的資料
             $.ajax({
                url: dUrl,
                        type: "post",
                        dataType: 'json',
                        cache: false,
                        async: false,
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        data: {
                        id : `${CDataID}`     
                      }
                    }).done(function (data) {
                               console.log(data);
                                 for(var item  of data)
                                 {
                                        let temptr = `<tr>` +
                                    `<td>${item.商品編號}</td>` +
                                    `<td>${item.商品名稱}</td>` +
                                    `<td>${item.尺寸種類}</td>` +
                                    `<td>${item.商品顏色種類}</td>` +
                                    `<td>${item.商品數量}</td>` +
                                    `<td>${item.商品分類名稱}</td>` +
                                    `<td>${item.鞋種}</td>` +
                                    `<td>${item.商品圖片1}</td>` +
                                    `<td>${item.商品圖片2}</td>` +
                                    `<td>${item.商品圖片3}</td>` +
                                    `<td>${item.商品是否上架}</td>` +
                                    `<td>${item.商品是否有貨}</td>` +
                                    `</tr>`;
                    appH += temptr;
                                 }
                       // alert("成功");   
                    }).fail(function () {
                        alert("失敗");                  
                    });
            console.log(appH)
            //cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;
            return '<table id="tableDetail" class="table table-borded tabale-info">' +
                '<thead>' +
                '<tr>' +
                '<th >編號</th>' +
                '<th >名稱</th>' +
                '<th >尺寸</th>' +
                '<th >顏色</th>' +
                '<th >數量</th>' +
                '<th >分類</th>' +
                '<th >鞋種</th>' +
                '<th >圖1</th>' +
                '<th >圖2</th>' +
                '<th >圖3</th>' +
                '<th >上架</th>' +
                '<th >有貨</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>'+
                appH
                '</tbody>' +
                '</table>';
        }
        function showphoto(detailsRecord) {
            if (detailsRecord.Photo != null) {
                //return "<div><img style='width:200px;' src='" + "@Url.Action("ShowPhoto", "Products")/" + detailsRecord.ProductID + "' title='" + detailsRecord.ProductName + "' /></div>";

            } else {
                return '<div><img style="display:block; margin:auto;"  src=' + "@Url.Content("~/img/404.png")></div>";
            }
        }

        //存資料夾
        function showphoto_other(detailsRecord) {
            var n = detailsRecord;
            //發佈可能會掛掉
            // var urlword = '<img src="/img/WebsiteOrder/Products/' + n + '.png" width="200" />';
            var urlword = `<img src="@Url.Content("~/img/WebsiteOrder/Customers")/${n}.jpg" width="200"  />`
            console.log("圖片狀態=" + urlword.status);
            console.log("圖片大小=" + urlword.fileSize);
            //if (urlword.status == 404) {
            //    return '<div><img style="display:block; margin:auto;"  src=' + '@Url.Content("~/img/404.png")></div>';
            //} else {
            //    return `<img src="@Url.Content("~/img/WebsiteOrder/Customers")/${n}.jpg" width="200" />`;
            //}
            return urlword;

        }

         //檢查錯誤圖檔
            document.addEventListener("error", function (e) {
                var elem = e.target;
                if (elem.tagName.toLowerCase() == 'img') {
                    elem.src = '@Url.Content("~/img/404.png")';
                }
            }, true);

        $(document).ready(function () {
                    funcLoad();
                });
    </script>

}

                  